<!doctype html>
<html>
<head>
    <title>LocalChat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<style>
    body {
        margin: 0;
    }
    #queue {
        position: absolute;
        max-height: 95%;
        max-height: calc(100% - 4em);
        overflow: auto;
        padding: .5em;
        word-break: break-word;
    }
    .writer {
        position: absolute;
        bottom: 0;
        margin: .5em;
    }
</style>

<body>

<select id="location"></select>
<div id="queue"></div>
<div class="writer">
    <input id="input" type="text"/>
    <button id="submit">Send</button>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    var MAX_LENGTH = 100;
    //var socket = io('http://107.170.252.81:3030');
    var socket = io('http://localhost:5000');

    var userId, sessionKey;

    function log() {
      console.log.apply(console, arguments);
    }

    socket.on('ping', log);

    socket.on('login failed', log);

    socket.on('login', function(data) {
        log('logged in', data);
        userId = data.id;
        sessionKey = data.sessionKey;
        navigator.geolocation.getCurrentPosition(function(position) {
            socket.emit('setLocation', {
                userId: userId,
                sessionKey: sessionKey,
                coords: {
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude
                }
            })
        }, log);
    });

    socket.on('setLocation', log);
    socket.on('setLocation failed', log);

    socket.on('chat', log);
    socket.on('sendChat failed', log);

    socket.on('register failed', log);

    function register(username, password) {
        socket.emit('register', {
            username: username,
            password, password
        });
    }

    function sendChat(chat) {
        if (!userId || !sessionKey) {
            throw new Error('not logged in!');
        }
        socket.emit('sendChat', {
            userId: userId,
            sessionKey: sessionKey,
            chat: chat
        });
    }

</script>
</body>
</html>
