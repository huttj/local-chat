'use strict';
const uuid         = require('uuid'),
      assert       = require('assert'),
      Message      = require('models/message'),
      usher        = require('usher'),
      _            = require('lodash'),
      mapper       = require('mapper'),
      authenticate = require('authenticate'),
      attachEvents = require('attach-events');

const Chatting = {};

Chatting.setLocation = function (payload) {
  const coords     = payload.coords,
        userId     = payload.userId,
        sessionKey = payload.sessionKey;

  authenticate(userId, sessionKey)
    .then(()=> mapper(coords))
    .then(location => {
      usher.enter(location, userId, this);
      this.emit('setLocation', location);
    })
    .catch(err => this.emit('setLocation failed', err));
};

Chatting.sendChat = function (payload) {
  const userId     = payload.userId,
        sessionKey = payload.sessionKey,
        chat       = payload.chat;

  authenticate(userId, sessionKey)
    .then(()=> {
      assert(chat, 'No chat provided');
      usher.sendChat({
        sender: userId,
        chat
      });
    })
    .catch(err => this.emit('sendChat failed', err))
};

Chatting.disconnect = function (payload) {
  usher.leave(this.userId);
};

module.exports = attachEvents(Chatting);